[gd_scene load_steps=7 format=2]

[ext_resource path="res://assets/ui/GUI.png" type="Texture" id=1]
[ext_resource path="res://assets/audio/sfx/ui/button_hover.wav" type="AudioStream" id=2]
[ext_resource path="res://assets/audio/sfx/towers/remove_tower.wav" type="AudioStream" id=3]
[ext_resource path="res://scenes/ui/layered_texture_button.tscn" type="PackedScene" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends MarginContainer

signal set_target_mode
signal remove_tower

onready var target_selector = get_node(\"MarginContainer/VBoxContainer/OptionButton\")
onready var remove_tower_audio = get_node(\"RemoveTower\")
onready var audio = get_node(\"ButtonHover\")
onready var remove_button = get_node(\"MarginContainer/VBoxContainer/HBoxContainer/MarginContainer/TextureButton\")
onready var fade_timer = get_node(\"Timer\")

var fade_tween: Tween

var _tower
var _text_to_mode := {
	\"First\": Constants.TowerTargetMode.FIRST,
	\"Last\": Constants.TowerTargetMode.LAST,
	\"Random\": Constants.TowerTargetMode.RANDOM,
	\"Lowest Health\": Constants.TowerTargetMode.LOWEST_HEALTH,
	\"Highest Health\": Constants.TowerTargetMode.HIGHEST_HEALTH,
}

func set_bound_to(t):
	_tower = t

func _ready():
	target_selector.connect(\"item_selected\", self, \"_on_select_target_mode\")
	remove_button.connect(\"button_down\", self, \"_on_press_remove\")
	remove_button.connect(\"mouse_entered\", self, \"_on_hover_button\")
	remove_button.connect(\"button_down\", remove_tower_audio, \"play\")
	fade_timer.connect(\"timeout\", self, \"_on_timeout\")
	
	connect(\"mouse_entered\", self, \"_on_mouse_enter\")
	connect(\"mouse_exited\", self, \"_on_mouse_exit\")
	connect(\"visibility_changed\", self, \"_on_visibility_changed\")
	
	_setup_target_mode_selector()

func _on_select_target_mode(mode):
	emit_signal(\"set_target_mode\", mode)

func _setup_target_mode_selector():
	for mode in _text_to_mode:
		target_selector.add_item(mode, _text_to_mode[mode])

func _on_hover_button():
	audio.play()

func _on_visibility_changed():
	if visible:
		modulate = Color.white
		fade_timer.start()
	else:
		modulate = Color.white

func _do_fade(time := 3.0):
	if fade_tween:
		_cancel_fade()

	fade_tween = Tween.new()
	add_child(fade_tween)
	fade_tween.interpolate_property(
		self,
		\"modulate\",
		Color.white,
		Color.transparent,
		time
	)
	fade_tween.start()
	fade_tween.connect(\"tween_all_completed\", self, \"_on_fade_finish\")

func _on_timeout():
	_do_fade(1.0)

func _on_mouse_exit():
	# since the mouse \"exits\" when we hover over a child, we check if the mouse
	# actually left this element!
	if !get_global_rect().has_point(get_global_mouse_position()):
		_do_fade(1.0)

func _cancel_fade():
	fade_tween.stop_all()
	fade_tween.queue_free()
	
	modulate = Color.white

func _on_mouse_enter():
	# stop time if it's on, since it'll cause this to fade
	if fade_timer.time_left > 0:
		fade_timer.stop()

	if fade_tween:
		_cancel_fade()

func _on_fade_finish():
	if fade_tween:
		fade_tween.queue_free()
		fade_tween = null

	visible = false
	modulate = Color.white

func _on_press_remove():
	_tower.visible = false
	yield(remove_tower_audio,\"finished\")
	emit_signal(\"remove_tower\")
"

[sub_resource type="AtlasTexture" id=2]
atlas = ExtResource( 1 )
region = Rect2( 81, 97, 30, 30 )

[node name="TowerUi" type="MarginContainer"]
margin_left = 13.0
margin_top = -24.0
margin_right = 49.0
margin_bottom = -4.0
mouse_filter = 1
size_flags_horizontal = 0
size_flags_vertical = 0
script = SubResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="NinePatchRect" type="NinePatchRect" parent="."]
margin_right = 41.0
margin_bottom = 50.0
texture = SubResource( 2 )
patch_margin_left = 6
patch_margin_top = 6
patch_margin_right = 6
patch_margin_bottom = 6

[node name="MarginContainer" type="MarginContainer" parent="."]
margin_right = 41.0
margin_bottom = 50.0
custom_constants/margin_right = 6
custom_constants/margin_top = 6
custom_constants/margin_left = 6
custom_constants/margin_bottom = 6

[node name="VBoxContainer" type="VBoxContainer" parent="MarginContainer"]
margin_left = 6.0
margin_top = 6.0
margin_right = 35.0
margin_bottom = 44.0
alignment = 1

[node name="HBoxContainer" type="HBoxContainer" parent="MarginContainer/VBoxContainer"]
margin_left = 7.0
margin_right = 21.0
margin_bottom = 14.0
size_flags_horizontal = 4
size_flags_vertical = 4
alignment = 1
__meta__ = {
"_edit_use_anchors_": false
}

[node name="MarginContainer" parent="MarginContainer/VBoxContainer/HBoxContainer" instance=ExtResource( 4 )]

[node name="OptionButton" type="OptionButton" parent="MarginContainer/VBoxContainer"]
margin_top = 18.0
margin_right = 29.0
margin_bottom = 38.0

[node name="Timer" type="Timer" parent="."]
wait_time = 3.0
one_shot = true

[node name="ButtonHover" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 2 )
bus = "Sound Effects"

[node name="RemoveTower" type="AudioStreamPlayer" parent="."]
stream = ExtResource( 3 )
bus = "Sound Effects"
